<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Hackathon 2015 - SUBTTL</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        <script src="http://use.typekit.net/gqr8pyu.js"></script>
        <script>try{Typekit.load();}catch(e){}</script>
        <link href="public/css/subttl.css" rel="stylesheet" type="text/css" media="all"/>
        <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular-sanitize.js"></script>
        
        <script>
    angular.module('subttlApp', ['ngSanitize'])
    .controller('subtitleSearchCtrl', function ($scope, $sce, $http) {
        $scope.hits = {};
        $scope.lang = 'fr';
        $scope.sendPost = function() {
            console.log($scope)
            var data = {
                          "query": {
                            "bool": {
                              "should": {
                                "match": {
                                  "subtitles.en": { 
                                    "query": $scope.searchText
                                  }
                                }
                              },
                              "should": {
                                "match": {
                                  "subtitles.fr": { 
                                    "query": $scope.searchText
                                  }
                                }
                              }
                            }
                          },
                          "highlight": {
                            "fields": {
                              "subtitles.en": { 
                                "fragment_size":1000
                              },
                              "subtitles.fr": { 
                                "fragment_size":1000
                              }
                            }
                          }
                        };
            $http.post("http://norman-vm1.nfb.ca:9200/nfb_films/films/_search", data ).success(function(data, status) {
                $scope.hits = data.hits.hits;
                $scope.hits.highlight_subtitles = [];
                $scope.hits.highlight_subtitles = $scope.hits.highlight['subtitles.en'];//.concat(scope.hits.highlight['subtitles.fr'])
                $scope.lang = 'fr';
            })
        }                   
    })
    </script>
    
        <style>


        </style>
        <!-- TODO: Complete this project :) -->
    </head>
    <body>
    

        <div class="container">

<div ng-app="subttlApp" ng-controller="subtitleSearchCtrl">             
    <div class="head">
        <h1 class="brand">Subttl</h1>

        <div class="search-boite big-boite">
                <form ng-submit="sendPost()">
                    <div class="row sfield">
                        <div class="col-xs-1"><i class="fa fa-quote-left fa-2x"></i></div>
                        <div class="col-xs-10">
                            <div class="input-group">
                              <input ng-model="searchText" type="text" class="form-control input-lg" placeholder="Recherche dans les sous-titres" />
                              <span class="input-group-btn">
                                <button type=submit class="btn btn-default btn-lg">&nbsp; <i class="fa fa-search fa-lg"></i> &nbsp;</button>
                              </span>
                            </div>
                             </div>
                        <div class="col-xs-1"><i class="fa fa-quote-right fa-2x"></i></div>
                    </div>
                </form> 
        </div>
    
    </div>


<div class="resultats">
    <ul class="liste-resultats list-unstyled">
        <li class="resultat" ng-repeat="x in hits">
            <div><img ng-src={{x._source.thumbnail_url.replace('https:','http:')}} alt=""></div>
            <h2 class="titre-film">{{ x._source.title }}</h2>
            <div>
                    <blockquote ng-repeat="tt in x.highlight['subtitles.fr'].concat(x.highlight['subtitles.en'])">
                    <!--blockquote ng-repeat="tt in x.highlight_subtitles"-->
                    <div>
                        <p ng-bind-html="tt.substring(14)"></p>
                        <footer>
                            <a data-timecode="{{ tt.substring(1, 13) }}" data-mp4="{{ x.video_url }}" data-vtt="http://norman-vm1.nfb.ca/subttl/FLASH/flash4{{ x._source.subtitles.ttxt_url_fr.replace('.ttxt', '.vtt') }}" 
                                class="play-clip" data-toggle="modal" data-target="#myModal">
                            <i class="fa fa-clock-o"></i> {{ tt.substring(1, 13) }} <i class="fa fa-play-circle"></i>
                            </a>
                        </footer>
                    </div>
                    </blockquote>
            </div>
        </li>
    </ul>
</div>



</div>


<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Modal title</h4>
      </div>
      <div class="modal-body">
      <!--p id="timecode"> . </p-->
      <video height="50%" width="50%" style="display:block; margin: 0 auto;" id="videoTag"  controls>
        <source src="http://nfbca-stream.nfbcdn.ca/FLASH/flash4/collection4/streams/M1M/films/1000_413526_406706_VI26048000_-.mp4" type="video/mp4" />
        <track label="English" kind="subtitles" srclang="en" src="http://norman-vm1.nfb.ca/subttl/FLASH/flash4/collection4/streams/TTXT/films/426106_532167_67_-.vtt" default />
        <p class="warning">Your browser does not support HTML5 video.</p>
      </video>
      
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>


    </div>
        <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
         <script type="text/javascript">
    var myTimecode = "00:00:00.000";
    var myVTT = ""
    var myMP4 = ""
    //var myTimecode = "00:00:00.000";
    //var sec = myTimecode.split('.');
    //var tt = sec[0].split(':');
    //var tSeek = getTimeSeek(myTimecode);

    function getTimeSeek (timeStamp){
      var sec = timeStamp.split('.');
      var tt = sec[0].split(':');
      return tt[0]*3600+tt[1]*60+tt[2]*1;
    }

    // hack sur body --- a investiquer pour le rendre plus specifique au modal #myModal
    $('body').on('hidden.bs.modal', '.modal', function () {
        //$("#timecode").val('');
        $('#videoTag').trigger('pause');
    });
     
    
    
    $('#myModal').on('shown.bs.modal', function() {
        //$("#timecode").val("00:15:35.279");
        
        //$('#divVideo video source').attr('src', myMP4);
        $('#divVideo video track').attr('src', myVTT);
        var timecode = myTimecode
        console.log(timecode)
        //var timestamp = "00:15:35.279"
        var tSeek = 0
        if (timecode) { tSeek = getTimeSeek(timecode); };
        $("#videoTag").get(0).currentTime = tSeek;
        $("#videoTag").get(0).play()
        $("#timecode").val(timecode);
    });

    $(document).on("click", ".play-clip", function () {
     myTimecode = $(this).data('timecode');
     myMP4 = $(this).data('mp4');
     myVTT = $(this).data('vtt');
     alert(myVTT)
});


      </script>
    </body>
</html>
